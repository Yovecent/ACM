# â›¹ï¸[å¤è‹å°å­©](https://ac.nowcoder.com/acm/contest/23480/E)

 ### :basecamp:(ä¸€)çº¿æ®µæ ‘
    
    æ„Ÿè§‰è¿˜æ˜¯é¢˜æ„Ÿå°‘ï¼Œæƒ³äº†ä¸€ä¸‹æ„Ÿè§‰å¥½åƒå’Œä¹‹å‰çš„å‡ ä¸ªçº¿æ®µæ•°å¾ˆæƒ³ï¼Œä½†æ˜¯æ€ä¹ˆä¹Ÿæƒ³ä¸å‡ºæ¥ã€‚
    å…¶å®è¿˜æ˜¯è¦å¤šå‘æ•£æ€ç»´ï¼Œå¤šæ¨æ¨å…¬å¼ã€‚
    
    é¦–å…ˆæˆ‘ä»¬åªçœ‹ä¸€ä¸ªäººçš„è´¡çŒ®ï¼š
    å‡è®¾ä»–ç°åœ¨æœ‰xï¼š
    (1) å¦‚æœä½¿ç”¨çš„æ˜¯ä»–ï¼š 
    é‚£ä¹ˆå› ä¸ºä¸‰è€…ç›¸åŠ æ’ä¸º3ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¡¨ç¤ºå‡ºä»–å˜åŒ–åçš„å€¼ï¼š
    x + (3 - x) / 2 ----> x/2 + 3/2
    (2)å¦‚æœé€‰çš„ä¸æ˜¯ä»–
    x/2
    
    æ‰€ä»¥æˆ‘ä»¬å¯¹äºæ¯ä¸€ä¸ªç‚¹ä¸è®ºæ˜¯ä¸æ˜¯é€‰çš„ä»–éƒ½ä¼šè®©ä»–å‡å°ä¸€åŠï¼ŒåŒæ—¶åœ¨åŠ ä¸Šä¸€ä¸ª 3/2
    
    æ‰€ä»¥æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ±‚è¿™äº›3/2çš„ç´¯åŠ 
    
    é‚£ä¹ˆæˆ‘ä»¬å‡è®¾åŒºé—´ä¸º[L,R]
    å‡å¦‚æˆ‘ä»¬åœ¨xä½ç½®è¢«é€‰å³è·å¾—3/2ï¼Œé‚£ä¹ˆè¿™ä¸ª3/2æœ€ç»ˆä¼šå˜æˆ (3/2)/ (2 ^ (R-x))
    ä¹Ÿå°±æ˜¯è¯´å…¶å°±æ˜¯ä¸€ä¸ª 1/2è¿›åˆ¶ï¼Œä¹‹å‰æˆ‘ä»¬æ±‚çš„æ˜¯2è¿›åˆ¶ï¼Œè¿™ä¸ªå…¶å®å°±å’Œä»–ç±»ä¼¼ã€‚
    
    ä¹Ÿå°±æ˜¯è¯´info[p] = info[p << 1] * ((1/2) ^ len[p << 1| 1]) + len[p << 1 | 1]
    è€Œå¯¹äºæ¯ä¸€ä¸ªç‚¹å¦‚æœæ˜¯è¢«é€‰ç‚¹é‚£å°±æ˜¯3/2å¦åˆ™å°±æ˜¯0ï¼Œç„¶åå°±æ˜¯ç¦æ­¢çš„æ±‚å’Œã€‚
    
    æ±‚å’Œå®Œä¹‹ååœ¨åœ¨ä¸Šå¯¹ 1^(r - l + 1)å°±å¯ä»¥äº†ã€‚
```C++
#include <bits/stdc++.h>

#define endl '\n'
using namespace std;
using i64 = long long;
const int maxn = 2e5 + 10, mod = 998244353;

string s;
i64 inv[maxn + 1], pm, ok;
int n, q;
struct SegmentTree{

    i64 info[maxn << 2][4], res[4];
    int len[maxn << 2];
    void pushup(int p){
        len[p] = len[p << 1] + len[p << 1 | 1];
        for (int i = 1; i <= 3 ; i++) {
            info[p][i] = (info[p << 1][i] * inv[len[p << 1 | 1]] % mod + info[p << 1 | 1][i]) % mod;
        }
    }
    void build(int p, int l, int r){
        if (l == r) {
            info[p][s[l] - '0'] = ok; len[p] = 1;
            return; 
        }
        int mid = l + r >> 1;
        build(p << 1, l, mid);
        build(p << 1 | 1, mid + 1, r);
        pushup(p);
    }
    void update(int p, int l ,int r, int x, int val){
        if(l == r){
            info[p][val] = ok; 
            if(val != s[l] - '0') info[p][s[l] - '0'] = 0;//è¿™ä¸ªé—®é¢˜æ‰¾äº†å¥½ä¹…ï¼ŒçœŸçš„éº»äº†
            s[l] = val + '0'; 
            return;
        }
        int mid = l + r >> 1;
        if(x <= mid) update(p << 1, l, mid, x, val);
        else         update(p << 1 | 1, mid + 1, r, x, val);
        pushup(p);
    }
    void query(int p, int l, int r, int L, int R,int i){
        if(l >= L && r <= R){
            res[i] = (res[i] + info[p][i] * inv[R - r] % mod) % mod;
            return;
        }
        int mid = l + r >> 1;
        i64 ans = 0;
        if(L <= mid) query(p << 1, l, mid, L, R, i);
        if(R > mid)  query(p << 1 | 1, mid + 1, r, L, R, i);
    }
}tree;
i64 ksm(i64 a,int b){

    i64 res = 1;
    while(b){
        if(b & 1) res = res * a % mod;
        a = a * a % mod;
        b >>= 1;
    }
    return res;
}
void init(){

    pm = ksm(2, mod - 2); ok = pm * 3 % mod;
    inv[0] = 1;
    for(int i = 1 ; i <= n ; i++) inv[i] = inv[i - 1] * pm % mod;
}
int main()
{
#ifndef ONLINE_JUDGE
freopen("in.txt","r",stdin);
freopen("out.txt","w",stdout);
#endif
    ios::sync_with_stdio(false);cin.tie(nullptr);

    cin >> n >> q;
    init();

    cin >> s; s = 'X' + s;

    tree.build(1, 1, n);
    while(q--){

        int opt, x, y;
        cin >> opt >> x >> y;
        if (opt == 1) {
            tree.update(1, 1, n, x, y);
        } else {
            for(int i = 1; i <= 3 ; i++){
                tree.res[i] = 0;
                tree.query(1, 1, n, x, y, i);
                cout << (inv[y - x + 1] + tree.res[i]) % mod << " ";
            }
            cout << endl;
        }
    }
    return 0;
}

```

### ğŸª•ï¼ˆ2ï¼‰çŸ©é˜µä¹˜æ³•

    çŸ©é˜µä¹˜æ³•è¿˜æ˜¯æš‘æœŸé›†è®­å­¦çš„ï¼Œå½“æ—¶å°±è¢«è¿™ä¸ªç®—æ³•æ‰€éœ‡æ’¼ï¼Œç‰¹åˆ«å–œæ¬¢ï¼ï¼ï¼ï¼
    
    è¿™é“é¢˜ç”¨çŸ©é˜µå¿«é€Ÿå¹‚çœŸçš„é€šä¿—æ˜“æ‡‚ï¼Œè€Œä¸”ç®€å•ï¼ï¼ï¼
    
    é¦–å…ˆå¯¹äºå½“å‰è¿™ä¸€ä½å¦‚æœæ˜¯'1'ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„å˜åŒ–å°±æ˜¯ï¼š
    (x, y, z) -----> (x + y/2 + z/2, y/2, z/2)
    é‚£ä¹ˆæˆ‘ä»¬å…¶å®å°±å¯ä»¥çœ‹ä½œæ˜¯ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜
    |x y z|      |1    0    0  |
    |0 0 0|   *  |1/2  1/2  0  |
    |0 0 0|      |1/2  0    1/2|
    åŒç†æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ '2', '3'çš„çŸ©é˜µæ±‚å‡ºæ¥ã€‚
    
    ç„¶åå…¶å®æˆ‘ä»¬ä»[L,R]å°±æ˜¯è®©è¿™ä¸€æ®µçš„æ‰€æœ‰çŸ©é˜µç´¯ä¹˜çš„ç»“æœã€‚(å¤§ä¸ºéœ‡æ’¼ï¼ŒçœŸæ˜¯å¤ªå¦™äº†)
    
    æ‰€ä»¥æˆ‘ä»¬å°±åˆ©ç”¨çº¿æ®µæ ‘ï¼ŒæŠŠinfoéƒ½è®¾ç½®ä¸ºçŸ©é˜µï¼Œç„¶åå°±æ˜¯çº¿æ®µæ ‘çš„åŸºæ“äº†ã€‚
    åŒæ—¶å¯¹äºqueryæ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥è®¾å®šä¸€ä¸ªå…¨å±€çš„å•ä½çŸ©é˜µ(å¯¹è§’çº¿ä¸º1ï¼Œå…¶ä»–å…¨ä¸º0),å°†çº¿æ®µæ ‘çš„æŸ¥è¯¢ç»“æœè¿›è¡Œç´¯ä¹˜ã€‚
    
```C++
#include <bits/stdc++.h>

using namespace std;
using i64 = long long;
const int maxn = 1e5 + 10, mod = 998244353;

string s;
int n, q;

struct Mat{ //è¿™æ ·åˆå§‹åŒ–å°±å¯ä»¥å°†å…¶éƒ½ä¸º0ï¼Œä¸ç„¶å¯èƒ½ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„bug

    i64 c[3][3] = {
        {0, 0, 0},
        {0, 0, 0},
        {0, 0, 0}
    };
}ans;
Mat operator *(Mat a,Mat b){//å®šä¹‰çŸ©é˜µä¹˜æ³•çš„é‡è½½
    Mat C;
    for(int i =  0 ; i < 3;  i++){
        for(int j = 0 ; j < 3 ; j++){
            for(int k = 0 ; k < 3 ; k++){
                C.c[i][j] = (C.c[i][j] + a.c[i][k] * b.c[k][j] % mod) % mod;
            }
        }
    }
    return C;
}
i64 ksm(i64 a,int b){

    i64 res = 1;
    while(b){
        if(b & 1) res = res * a % mod;
        a = a * a % mod;
        b >>= 1;
    }
    return res;
}  
void init(Mat &m,char k){//&å–åœ°å€å¯¹å…¶ç›´æ¥ä¿®æ”¹

    i64 t = ksm(2, mod - 2);
    Mat tmp;
    m = tmp;
    if(k == 1){
        m.c[0][0] = 1;
        m.c[1][0] = t, m.c[1][1] = t;
        m.c[2][0] = t, m.c[2][2] = t; 
    } else if (k == 2) {
        m.c[0][0] = t, m.c[0][1] = t;
        m.c[1][1] = 1;
        m.c[2][1] = t, m.c[2][2] = t; 
    } else {
        m.c[0][0] = t, m.c[0][2] = t;
        m.c[1][1] = t; m.c[1][2] = t;
        m.c[2][2] = 1; 
    }
} 
struct SegmentTree{

    Mat info[maxn << 2];
    void build(int p,int l,int r){
        if(l == r){
            init(info[p], s[l] - '0');
            return;
        }
        int mid = l + r >> 1;
        build(p << 1, l, mid);
        build(p << 1 | 1, mid + 1, r);
        info[p] = info[p << 1] * info[p << 1| 1];
    }
    void update(int p,int l,int r, int x,int val){
        if(l == r){
            init(info[p], val);
            return;
        }
        int mid = l + r >> 1;
        if(x <= mid) update(p << 1, l, mid, x, val);
        else         update(p << 1 | 1, mid + 1, r, x, val);
        info[p] = info[p << 1] * info[p << 1| 1];
    }
    void query(int p,int l,int r,int L,int R){
        if(l >= L && r <= R){
            ans = ans * info[p];
            return;
        }
        int mid = l + r >> 1;
        if(L <= mid) query(p << 1, l, mid, L, R);
        if(R > mid)  query(p << 1 | 1, mid + 1, r, L, R);
    }

}tree;
int main()
{
#ifndef ONLINE_JUDGE
freopen("in.txt","r",stdin);
freopen("out.txt","w",stdout);
#endif
    ios::sync_with_stdio(false);cin.tie(nullptr);

    cin >> n >> q;
    cin >> s; s = 'X' + s;

    tree.build(1, 1, n);
    while(q--){
        int opt, l, r;
        cin >> opt >> l >> r;
        if (opt == 1) {
            tree.update(1, 1, n, l, r);
        } else {
            for(int i = 0 ; i < 3 ; i++){//è®¾å®šå•ä½å‘é‡
                for(int j = 0 ; j < 3 ; j++){
                    ans.c[i][j] = i == j ? 1 : 0;
                }
            }
            tree.query(1, 1, n, l, r);
            Mat x;
            for(int i = 0 ; i < 3; i++) x.c[0][i] = 1;
            x = x * ans;
            for(int i = 0 ; i < 3; i++) cout << x.c[0][i] << " ";
            cout << endl;
        }
    }

    return 0;
}
```
```diff
!     ğŸ’±2022-03-17
```
    
