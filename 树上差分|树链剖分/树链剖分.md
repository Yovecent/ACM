
[sss](https://www.luogu.com.cn/blog/zengqinyi/solution-p3384)
[oo](https://www.cnblogs.com/ivanovcraft/p/9019090.html)
[luogu](https://www.luogu.com.cn/problem/P3384)
# ğŸ¹æ ‘é“¾å‰–åˆ†
    ğŸŒ‚åœ¨å­¦ä¹ äº†å·®åˆ†ä¹‹åï¼Œæ‰æ‡‚å¾—äº†æ ‘é“¾å‰–åˆ†å­˜åœ¨çš„æ„ä¹‰ã€‚å› ä¸ºå¯¹äºå¦‚æœè¯´åªæœ‰å¤šæ¬¡ä¿®æ”¹ç‚¹çš„æƒå€¼ï¼Œåªæœ‰ä¸€æ¬¡æŸ¥è¯¢çš„è¯ï¼Œæ ‘ä¸Šå·®åˆ†å¯ä»¥è¯´æ˜¯
    ç›¸å½“ä¼˜ç§€çš„ä¸€ä¸ªç®—æ³•ï¼Œä»–çš„ä¿®æ”¹æ“ä½œå¤æ‚åº¦éƒ½æ˜¯log(n)ï¼ŒæŸ¥è¯¢æ“ä½œæ˜¯O(n)ï¼Œä½†å”¯ä¸€ä¸è¶³çš„æ˜¯ï¼Œå¦‚æœè¯´æˆ‘ä»¬æƒ³è¾¹ä¿®æ”¹è¾¹æŸ¥è¯¢çš„è¯ï¼Œå°±æ˜¾ç°
    å‡ºå®ƒçš„å¼Šç«¯äº†ï¼Œå› ä¸ºå¯¹äºæ¯ä¸€æ¬¡æŸ¥è¯¢å‰ï¼Œæˆ‘ä»¬éƒ½è¦è¿›è¡Œä¸€æ¬¡dfsï¼ŒåŒå‰ç¼€å’Œçš„æ€æƒ³ï¼Œä»¥æŠŠæ‰€æœ‰çš„ç‚¹éƒ½æ›´æ”¹ä¸ºçœŸæ­£çš„å€¼ã€‚ä½†æ¯æ¬¡dfsæ—¶é—´éƒ½
    æ˜¯O(n)ï¼Œå¹¶ä¸ä¼˜ç§€ã€‚è¿™æ—¶æ ‘é“¾å‰–åˆ†å°±ç™»åœºäº†ï¼ï¼ï¼ï¼
    
    
    ğŸ¦¼æ ‘é“¾å‰–åˆ†æ˜¯é›†ä¿®æ”¹ä¸æŸ¥è¯¢äºä¸€èº«çš„ç®—æ³•ï¼Œä¸”æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯log(n),å…¶å®è¯´ç™½äº†ï¼Œæ ‘é“¾å‰–åˆ†å°±æ˜¯æ ‘ä¸Šçº¿æ®µæ ‘ã€‚
    

```diff
+   å¯¹äºæ ‘é“¾å‰–åˆ†å…¶å®ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„ç®—æ³•ï¼ŒåŸºæœ¬æ€æƒ³å°±æ˜¯æŠŠæ ‘ä¸Šçš„ç‚¹è½¬åŒ–ä¸ºä¸€ç»´çš„è¿ç»­ç‚¹ï¼Œç„¶ååˆ©ç”¨çº¿æ®µæ ‘çš„æ“ä½œï¼Œä¿®æ”¹ä¸æŸ¥è¯¢ã€‚
```

## å¯¹äºè½¬åŒ–ä¸ºçº¿æ®µæ ‘çš„æ±‚æ³•æœ‰å›ºå®šçš„æ­¥éª¤ï¼š  

###  ï¼ˆ1ï¼‰ä¸¤éDFS
        
        ç¬¬ä¸€éDFSï¼Œæ±‚å¾—æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„æ·±åº¦ï¼Œçˆ¶èŠ‚ç‚¹ï¼Œä»¥å½“å‰èŠ‚ç‚¹ä¸ºç¥–å®—èŠ‚ç‚¹æ„æˆçš„å­æ ‘å¤§å°ï¼Œä»¥åŠé‡å„¿å­ï¼ˆèŠ‚ç‚¹æ•°æœ€å¤šçš„å„¿å­ï¼‰ã€‚
        
        ç¬¬äºŒéDFSï¼Œå¯¹äºæ ‘è¿›è¡Œé‡æ–°è§„åˆ’ï¼Œé‡æ–°å®šä¹‰æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„åºå·ï¼Œæ±‚å‡ºæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„topç‚¹ï¼Œï¼ˆè®°ä¸ºé‡é“¾æˆ–è½»é“¾çš„èŠ‚ç‚¹åŸåºå·ï¼‰
        
        é€šè¿‡è¿™ä¸¤éƒ¨ï¼Œæˆ‘ä»¬å°±å¯¹æ•´æ£µæ ‘è¿›è¡Œäº†é‡æ–°è§„åˆ’ï¼Œä½¿å¾—åœ¨ä¸€æ¡é‡é“¾çš„èŠ‚ç‚¹çš„æ–°åºå·æ˜¯è¿ç»­çš„ã€‚

```C++
inline void dfs1(int u,int f,int deep){
    dep[u]=deep;
    fa[u]=f;
    size[u]=1;
    int Max=-1;
    for(int i=head[u];~i;i=ed[i].Next){
        int to=ed[i].to;
        if(to == f ) continue;
        dfs1(to,u,deep+1);
        size[u]+=size[to];
        if(size[to] > Max){
            Max=size[to],son[u]=to;
        }
    }
}

inline void dfs2(int u,int tp){

    id[u]=++cnt;
    w[cnt]=a[u];
    top[u]=tp;
    if(!son[u]) return;
    dfs2(son[u],tp);
    for(int i = head[u] ;~i ;i=ed[i].Next){
        int to=ed[i].to;
        if(to == fa[u] || to == son[u]) continue;
        dfs2(to,to);
    }
}
```
### ï¼ˆ2ï¼‰ç„¶åæŒ‰ç…§çº¿æ®µæ ‘çš„æ­¥éª¤ï¼Œbuildå¥½æ ‘çš„æ¯ä¸€å±‚ã€‚
        
        ğŸ©¹æ²¡å•¥è®²çš„ï¼Œå¯¹äºçº¿æ®µæ ‘ï¼Œæˆ‘è§‰å¾—å°½é‡éƒ½æ‰‹æ•²å‡ºæ¥ï¼Œå…¶å®ç”¨å¤šäº†å°±è§‰å¾—æ²¡å•¥äº†ã€‚
        

###  (3) å†™å‡ºupdRange ä¸ qRangeå‡½æ•°

       ğŸ§¸è¿™ä¸ªåº”è¯¥å°±æ˜¯æ ‘é“¾å‰–åˆ†ä¸­æœ€ä¸ºç²¾é«“çš„åœ°æ–¹äº†ï¼Œå¹¶ä¸”è§£é‡Šäº†é‡é“¾çš„å®Œç¾è¿ç”¨ã€‚
       
       updRangeå’ŒqRangeå‡½æ•°ï¼Œéƒ½æ˜¯èµ°äº†ä¸€ä¸‹ä»èŠ‚ç‚¹uåˆ°èŠ‚ç‚¹vçš„æœ€çŸ­è·¯ï¼Œåªæ˜¯è¦å®ç°çš„ç›®çš„ä¸åŒã€‚
       
       å½“x,yçš„topç‚¹ä¸ä¸€æ ·ï¼Œå³ä¸åœ¨ä¸€æ¡é‡é“¾ä¸Šé¢ï¼Œå°±ä¸æ–­åœ°èµ°dep[top[x]]ï¼Œæ›´å¤§å³æ›´ä½çš„é‚£æ¡é“¾ï¼Œæ‰€ä»¥ï¼Œé‡é“¾çš„å¥½å¤„å°±åœ¨äºæˆ‘ä»¬å¯ä»¥ä¸ç”¨
       ä¸€ä¸ªä¸€ä¸ªèµ°ï¼Œè€Œæ˜¯ä¸€ä¸‹å­èµ°ä¸€æ¡é‡é“¾ã€‚
       
```C++
inline int qRange(int x,int y){

    int ans=0;
    while(top[x]!=top[y]){
        if(dep[top[x]] < dep[top[y]]) swap(x,y);
        ans+=query(1,1,n,id[top[x]],id[x]);
        x=fa[top[x]];
    }
    if(dep[x] > dep[y]) swap(x,y);
    ans+=query(1,1,n,id[x],id[y]);
    return ans;
}
```


      ç„¶åæ ‘é“¾å‰–åˆ†çš„æ€§è´¨æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š
```diff
+     è®¾v,ä¸ºuçš„è½»å„¿å­ï¼Œåˆ™ size[v]<=size[u]/2;
+     ä»æ ¹åˆ°ä»»æ„èŠ‚ç‚¹çš„è½»é“¾å’Œé‡é“¾éƒ½ä¸è¶…è¿‡log(n)æ¡ï¼ˆæ—¶é—´å¤æ‚åº¦çœŸä¼˜ç§€ï¼‰

```


##  æ ‘é“¾å‰–åˆ†æ±‚LCA

```C++

    int LCA(int x,int y){

        while(top[x]!=top[y]){
            if(dep[x]<dep[y]) swap(x,y);
            x=fa[top[x]];
        }
        if(dep[x]>dep[y]) swap(x,y); //æœ€åèŠ‚ç‚¹æ›´é«˜çš„å°±æ˜¯LCA
        return x;
        
    }
```
