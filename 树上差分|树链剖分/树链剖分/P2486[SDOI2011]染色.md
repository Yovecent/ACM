#  [P2486 [SDOI2011]æŸ“è‰²](https://www.luogu.com.cn/problem/P2486)

    è¿™é“é¢˜å°±æ˜¯æ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘ï¼Œä½†æ˜¯è€ƒå¯Ÿçš„æ˜¯æ€ç»´ã€‚  
    
    
    ğŸ¥‘å¯¹äºè¿™é“é¢˜ï¼Œæˆ‘ä»¬ä¸èƒ½åªæ˜¯å•çº¯çš„åœ¨ç”¨çº¿æ®µæ ‘çš„åŒºé—´åŠ å’Œï¼Œå› ä¸ºåœ¨è¿æ¥æ—¶ï¼Œå¯èƒ½ä¼šæœ‰ä»¥ä¸‹ä¸¤ç§é—®é¢˜ã€‚
    
    (1)   11221 3221 é‚£ä¹ˆè¿æ¥ä¹‹åæ€»æ•°å°±æ˜¯6
    (2)   11221 1221 é‚£ä¹ˆè¿æ¥åæ€»æ•°ä¸º5
    
    æ‰€ä»¥æˆ‘ä»¬åœ¨è¿æ¥æ—¶ï¼Œåº”è€ƒè™‘è¿æ¥ç‚¹å¤„ä¸¤ç§é¢œè‰²æ˜¯å¦ç›¸åŒã€‚æ‰€ä»¥å¢åŠ ä¸¤ä¸ªæ•°ç»„æ¥ç¡®å®šçº¿æ®µå·¦å³ç«¯ç‚¹çš„é¢œè‰²ï¼Œè¿ç”¨å•ç‚¹æŸ¥è¯¢
    æ£€æŸ¥å³å¯ã€‚
    
    å…¶æ¬¡å°±æ˜¯åœ¨qRangeå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä¸æ–­åœ°å¾€ä¸Šè·‘ï¼Œä½†è·‘å¾—è·¯å¾„ä¼šä¸æ–­å˜åŒ–ï¼Œå¦‚æœè®°å½•çš„è¯å¹¶ä¸çŸ¥é“å’Œè°å»æ¯”è¾ƒã€‚
    è¿™é‡Œæœ‰ä¸€ç§æ–¹æ³•ï¼Œå°±æ˜¯åªçœ‹ top[x] å’Œ fa[top[x]]çš„é¢œè‰²æ˜¯å¦ç›¸åŒï¼Œç›¸åŒå‡ä¸€ã€‚å› ä¸ºæˆ‘ä»¬æ€»è¦æŠŠä¸Šé¢çš„è¿æ¥èµ·æ¥ï¼Œæ‰€ä»¥æ€»ä¼šè€ƒè™‘çš„åˆ°ã€‚
    
    
    
ä¸‹é¢æ˜¯ACä»£ç 
```C++
#include <iostream>
#include <cstdio>
#include <cstring>

using namespace std;
const int maxn = 1e5+10;

int n,q,cnt=0,head[maxn<<1];
int dep[maxn],fa[maxn],top[maxn],size[maxn],son[maxn],id[maxn];
int tr[maxn<<2],tR[maxn<<2],tL[maxn<<2],ly[maxn<<2],a[maxn],b[maxn];
struct node{
    int to,Next;
}ed[maxn<<1];

void add(int u,int v){

    ed[cnt].to=v;
    ed[cnt].Next=head[u];
    head[u]=cnt++;
}

void dfs1(int u,int pre,int deep){

    size[u]=1;
    dep[u]=deep;
    fa[u]=pre;
    int Max=-1;
    for(int i = head[u] ; ~i ; i=ed[i].Next){
        int to=ed[i].to;
        if(to == pre) continue;
        dfs1(to,u,deep+1);
        size[u]+=size[to];
        if(size[to] > Max){
            Max=size[to],son[u]=to;
        }
    }
}

void dfs2(int u,int tp){

    id[u]=++cnt;
    top[u]=tp;
    if(!son[u]) return;
    dfs2(son[u],tp);
    for(int i = head[u] ; ~i ; i=ed[i].Next){
        int to=ed[i].to;
        if(to == fa[u] || to == son[u]) continue;
        dfs2(to,to);
    }
}

void pushdown(int p,int l,int r){

    ly[p<<1]=ly[p];ly[p<<1|1]=ly[p];
    tr[p<<1]=1,tr[p<<1|1]=1;
    tL[p<<1]=ly[p],tR[p<<1]=ly[p],tL[p<<1|1]=ly[p],tR[p<<1|1]=ly[p];
    ly[p]=0;
}
void pushup(int p,int l,int r){

    tr[p]=tr[p<<1]+tr[p<<1|1];
    if(tR[p<<1] == tL[p<<1|1]) tr[p]--;
    tL[p]=tL[p<<1],tR[p]=tR[p<<1|1];
}
void build(int p,int l,int r){
    if(l == r){
        tr[p]=1;tL[p]=a[l];tR[p]=a[l];
        return;
    }
    int mid=l+r>>1;
    if(l<=mid) build(p<<1,l,mid);
    if(r>mid)  build(p<<1|1,mid+1,r);
    pushup(p,l,r);
}
void update(int p,int l,int r,int L,int R,int c){
    if(l >= L && r <= R){
        tr[p]=1;
        ly[p]=c;
        tL[p]=tR[p]=c;
        return;
    }
    if(ly[p]) pushdown(p,l,r);
    int mid=l+r>>1;
    if(L<=mid) update(p<<1,l,mid,L,R,c);
    if(R>mid)  update(p<<1|1,mid+1,r,L,R,c);
    pushup(p,l,r);
}
void updRange(int x,int y,int c){

    while(top[x]!=top[y]){
        if(dep[top[x]] < dep[top[y]]) swap(x,y);
        update(1,1,n,id[top[x]],id[x],c);
        x=fa[top[x]];
    }
    if(dep[x]>dep[y]) swap(x,y);
    update(1,1,n,id[x],id[y],c);
}

int  query(int p,int l,int r,int L,int R){
    if(l>=L && r <= R){
        return tr[p];
    }
    if(ly[p]) pushdown(p,l,r);
    int mid=l+r>>1;int res=0;
    bool f=false,ff=false;
    if(L<=mid) res+=query(p<<1,l,mid,L,R),f=true;
    if(R>mid)  res+=query(p<<1|1,mid+1,r,L,R),ff=true;
    if(f&&ff){
        if(tR[p<<1] == tL[p<<1|1]) res--;
    }
    return res;
}

int query_col(int p,int l,int r,int x){
    if(l == r){
        return tL[p];
    }
    if(ly[p]) pushdown(p,l,r);
    int mid=l+r>>1;
    if(x<=mid) return query_col(p<<1,l,mid,x);
    else       return query_col(p<<1|1,mid+1,r,x);

}
int qRange(int x,int y){

    int ans=0;
    while(top[x]!=top[y]){
        if(dep[top[x]] < dep[top[y]])swap(x,y);
        ans+=query(1,1,n,id[top[x]],id[x]);
        int l_col=query_col(1,1,n,id[fa[top[x]]]);
        int r_col=query_col(1,1,n,id[top[x]]);
        if(l_col == r_col) ans--;
        x=fa[top[x]];
    }
    if(dep[x]>dep[y]) swap(x,y);
    ans+=query(1,1,n,id[x],id[y]);//æœ€åä¸€æ¬¡å¹¶ä¸ç”¨è€ƒè™‘æ˜¯å¦ç›¸åŒï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆ
    return ans;
}
int main()
{
#ifndef ONLINE_JUDGE
    freopen("in.txt","r",stdin);
    freopen("out.txt","w",stdout);
#endif
    memset(head,-1,sizeof head);
    scanf("%d %d",&n,&q);
    for(int i = 1; i <= n ; i++){
        scanf("%d",&b[i]);
    }
    for(int i = 1; i < n ; i++){
        int u,v;scanf("%d %d",&u,&v);
        add(u,v),add(v,u);
    }
    dfs1(1,1,1);cnt=0;
    dfs2(1,1);
    for(int i = 1; i <= n ; i++){
        a[id[i]]=b[i];
    }
    build(1,1,n);
    while(q--){
        char s[10];scanf("%s",s);
        int a,b,c;
        if(s[0] == 'C'){
            scanf("%d %d %d",&a,&b,&c);
            updRange(a,b,c);
        }
        else{
            scanf("%d %d",&a,&b);
            printf("%d\n",qRange(a,b));
        }
    }
    return 0;
}
```
    
    
    
    
